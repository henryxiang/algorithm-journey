# 线段树专题2-线段树的离散化、二分搜索、特别修改

前置知识

讲解110 \- 线段树原理和代码详解

线段树专题讲述顺序

专题1：线段树原理和代码详解，讲解110

专题2：线段树的离散化、二分搜索、特别修改，讲解111，本节

专题3：线段树维护更多类型的信息，讲解112

专题4：线段树解决区间合并的问题，讲解113

专题5：开点线段树、区间最值和历史最值，讲解114

专题6：线段树与扫描线结合的题目，讲解115

线段树与动态规划结合的内容，后续【扩展】标签下的课程里继续安排

树套树、可持久化线段树、树链剖分等内容，后续【挺难】标签下的课程里会安排

这个系列一定是全网有关线段树最好的教学视频，觉得好帮忙推荐给身边的人！

题目1

掉落的方块

有一个二维平面，x轴是最底的边界

给定二维整数数组pos，pos\[i\] = \[ lefti\, leni \]

表示第i个方块边长为leni，左侧边缘在x = lefti位置，所在高度非常高

所有方块都是正方形，依次从高处垂直掉落，也就是左边界顺着x = lefti往下

如果掉落的方块碰到已经掉落正方形的顶边或者x轴就停止掉落

如果方块掉落时仅仅是擦过已经掉落正方形的左侧边或右侧边，并不会停止掉落

一旦停止，它就会固定在那里，无法再移动，俄罗斯方块游戏和本题意思一样

返回一个整数数组ans ，其中ans\[i\]表示在第i块方块掉落后整体的最大高度

1 <= pos数组长度 <= 1000，1 <= lefti <= 10^8，1 <= leni <= 10^6

测试链接 : [https://leetcode\.cn/problems/falling\-squares](https://leetcode.cn/problems/falling-squares)

值域线段树的离散化

题目2

瓶子里的花朵

给定n个瓶子，编号从0~n\-1，一开始所有瓶子都是空的

每个瓶子最多插入一朵花，实现以下两种类型的操作

操作 1 from flower : 一共有flower朵花，从from位置开始依次插入花朵，已经有花的瓶子跳过

如果一直到最后的瓶子，花也没有用完，就丢弃剩下的花朵

返回这次操作插入的首个空瓶的位置 和 最后空瓶的位置

如果从from开始所有瓶子都有花，打印"Can not put any one\."

操作 2 left right  : 从left位置开始到right位置的瓶子，变回空瓶，返回清理花朵的数量

测试链接 : [https://acm\.hdu\.edu\.cn/showproblem\.php?pid=4614](https://acm.hdu.edu.cn/showproblem.php?pid=4614)

线段树 \+ 二分搜索的结合

题目3

范围上开平方并求累加和

给定一个长度为n的数组arr，实现以下两种类型的操作

操作 0 l r : 把arr\[l\.\.r\]范围上的每个数开平方，结果向下取整

操作 1 l r : 查询arr\[l\.\.r\]范围上所有数字的累加和

两种操作一共发生m次，数据中有可能l>r，遇到这种情况请交换l和r

1 <= n\, m <= 10^5，1 <= arr\[i\] <= 10^12

测试链接 : [https://www\.luogu\.com\.cn/problem/P4145](https://www.luogu.com.cn/problem/P4145)

一段范围上，每个数字进行开方操作之后，范围的累加和信息并不能够快速得到

本题不满足经典线段树范围修改功能的要求，回顾一下上节课内容

一个数字即便是最大值10^2，也就开方6次，就会向下取整变成1，以后再也不需要执行开方

需要势能分析来评估复杂度，还有剪枝的重要性，一般的剪枝只是优化常数时间，这里要重要的多

预告：讲解114，线段树的区间最值操作，还会用到势能分析

题目4

包含取模操作的线段树

给定一个长度为n的数组arr，实现如下三种操作，一共调用m次

操作 1 l r : 查询arr\[l\.\.r\]的累加和

操作 2 l r x : 把arr\[l\.\.r\]上每个数字对x取模

操作 3 k x : 把arr\[k\]上的数字设置为x

1 <= n\, m <= 10^5，操作1得到的结果，有可能超过int范围

测试链接 : [https://www\.luogu\.com\.cn/problem/CF438D](https://www.luogu.com.cn/problem/CF438D)

一个数字v持续进行规模缩小的取模操作，次数上限是log v规模，因为值每次至少减一半

<span style="color:#000000">一段范围的每个数字进行取模操作之后，范围累加和信息并不能够快速得到</span>

需要势能分析来评估复杂度，还有剪枝的重要性，一般的剪枝只是优化常数时间，这里要重要的多

注意到操作3又会让势能增加，不过好在是单点操作，势能增加很有限，势能单次增加\(logv \* logn\)

预告：讲解114，线段树的区间最值操作，还会用到势能分析

题目5

贴海报

有一面墙，有固定高度，长度为n，有m张海报，所有海报的高度都和墙的高度相同

从第1张海报开始，一张一张往墙上贴，直到n张海报贴完

每张海报都给出张贴位置\(xi\, yi\)，表示第i张海报从墙的左边界xi一直延伸到右边界yi

有可能发生后面的海报把前面的海报完全覆盖，导致看不到的情况

当所有海报贴完，返回能看到海报的数量，哪怕只漏出一点的海报都算

1 <= n、xi、yi <= 10^7，1 <= m <= 10^3

测试链接 : [https://www\.luogu\.com\.cn/problem/P3740](https://www.luogu.com.cn/problem/P3740)

测试链接 : [http://poj\.org/problem?id=2528](http://poj.org/problem?id=2528)

值域线段树离散化 \+ 离散化特殊处理（增加中间点）\+ 维护信息的设计 \+ 针对题目的线段树改动

一段范围上的可见海报数量的信息，线段树维护不了，改去维护一段范围是否被某种海报全覆盖

最终想得到可见海报的数量，需要整体遍历线段树，但查询只有一次

